---
# playbooks/36_portainer_git_stacks.yml

- name: Create/Update Portainer stacks from Git (dynamic endpointId)
  hosts: mon-core
  become: false
  gather_facts: yes

  # Carga explícita de group_vars, por si Ansible no los recoge automáticamente
  pre_tasks:
    - name: Load group vars (all.yml) next to repo root
      include_vars:
        file: "{{ playbook_dir }}/../group_vars/all.yml"

    - name: Assert API token present
      assert:
        that:
          - (lookup('env', 'PORTAINER_TOKEN') | default('', true)) | length > 0
        fail_msg: "PORTAINER_TOKEN no está definido (exporta PORTAINER_TOKEN en el controlador)."
        success_msg: All assertions passed

    - name: Assert required variables exist
      assert:
        that:
          - portainer_url is defined
          - portainer_validate_certs is defined
          - stacks is defined
          - endpoint_aliases is defined
        fail_msg: "Faltan variables requeridas (portainer_url, portainer_validate_certs, stacks, endpoint_aliases)."
        success_msg: Basic variables present.

    - name: Wait for TCP {{ portainer_url | urlsplit('hostname') }}:{{ portainer_url | urlsplit('port') | default(9443) }}
      wait_for:
        host: "{{ portainer_url | urlsplit('hostname') }}"
        port: "{{ (portainer_url | urlsplit('port')) | default(9443) | int }}"
        delay: 0
        timeout: 60

    - name: Wait for /api/status (no auth)
      uri:
        url: "{{ portainer_url }}/api/status"
        method: GET
        validate_certs: "{{ portainer_validate_certs | default(false) }}"
        return_content: true
        follow_redirects: all
        status_code: 200
      register: status_check
      retries: 6
      delay: 5
      until: status_check.status is defined and status_check.status == 200

    - name: Portainer connectivity check (with API key)
      uri:
        url: "{{ portainer_url }}/api/system/status"
        method: GET
        headers:
          X-API-Key: "{{ lookup('env', 'PORTAINER_TOKEN') }}"
        validate_certs: "{{ portainer_validate_certs | default(false) }}"
        follow_redirects: all
        status_code: 200
        return_content: true
      register: system_status

    - name: Fail with clear message if API check != 200
      fail:
        msg: "Conectividad a Portainer falló (status {{ system_status.status | default('n/a') }}). Revisa URL/cert/token."
      when: system_status.status | default(0) != 200

    - name: Show connectivity check result (safe)
      debug:
        msg: "Portainer system/status OK (200)."