---
- name: Create/Update Portainer stacks from Git (CE 2.33.2)
  hosts: mon-core
  become: true
  gather_facts: false

  vars:
    # Si tu cert es self-signed
    portainer_validate_certs: false

  pre_tasks:
    - name: Resolver token (env primero, si no existe usa var portainer_token)
      ansible.builtin.set_fact:
        portainer_api_token: "{{ lookup('env','PORTAINER_TOKEN') | default(portainer_token | default('', true), true) }}"

    - name: Fallar si no hay token
      ansible.builtin.fail:
        msg: "No hay token para Portainer. Exporta PORTAINER_TOKEN o define portainer_token."
      when: portainer_api_token | length == 0

    - name: Verificar que existan variables requeridas
      ansible.builtin.assert:
        that:
          - portainer_url is defined
          - stacks is defined
          - stacks | length > 0
          - endpoints is defined
        fail_msg: "Faltan variables: portainer_url, stacks o endpoints. Revisa inventories/group_vars/all.yml."
        success_msg: "Variables b√°sicas presentes."

    - name: Verificar conectividad con Portainer
      ansible.builtin.uri:
        url: "{{ portainer_url }}/api/system/status"
        method: GET
        headers:
          X-API-Key: "{{ portainer_api_token }}"
        validate_certs: "{{ portainer_validate_certs }}"
        return_content: true
        status_code: 200
      register: _status

  tasks:
    - name: Crear/actualizar cada stack
      ansible.builtin.include_tasks: "tasks/portainer_stack.yml"
      loop: "{{ stacks }}"
      loop_control:
        loop_var: st